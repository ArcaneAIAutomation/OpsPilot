# ---------------------------------------------------------------------------
# OpsPilot — Default Configuration
# ---------------------------------------------------------------------------
# This file controls all system behavior. Modules are enabled/disabled here.
# Environment variables override values using the OPSPILOT_* prefix.
# ---------------------------------------------------------------------------

system:
  name: OpsPilot
  environment: development

modules:
  connector.fileTail:
    enabled: true
    path: ./logs/sample.log
    encoding: utf-8
    pollIntervalMs: 1000
    fromBeginning: false

  detector.regex:
    enabled: true
    maxIncidentsPerMinute: 30
    rules:
      - id: error-generic
        pattern: "\\bERROR\\b"
        flags: "i"
        severity: critical
        title: "Error detected in logs"
        description: "Log error detected: $0 — full line: $&"
        cooldownMs: 5000
      - id: warn-high-resource
        pattern: "(?:memory|cpu|disk) usage.*(\\d+)%"
        flags: "i"
        severity: warning
        title: "High resource usage detected"
        description: "Resource usage at $1%"
        cooldownMs: 30000

  enricher.incidentStore:
    enabled: true
    maxIncidents: 10000
    retentionMs: 86400000

  enricher.aiSummary:
    enabled: true
    provider: template
    model: template
    maxTokens: 500
    includeRunbook: true
    runbooks:
      - id: rb-high-memory
        title: "High Memory Usage Runbook"
        keywords: ["memory", "oom", "heap"]
        steps:
          - "Check process memory usage: top -o %MEM"
          - "Identify memory-heavy processes"
          - "Check for memory leaks in application logs"
          - "Consider restarting the affected service"
          - "Scale horizontally if load-driven"
      - id: rb-high-cpu
        title: "High CPU Usage Runbook"
        keywords: ["cpu", "load", "processor"]
        steps:
          - "Check CPU usage by process: top -o %CPU"
          - "Identify runaway processes"
          - "Check for infinite loops or deadlocks"
          - "Consider throttling or scaling"
      - id: rb-disk-space
        title: "Disk Space Runbook"
        keywords: ["disk", "storage", "space", "full"]
        steps:
          - "Check disk usage: df -h"
          - "Find large files: du -sh /* | sort -rh | head -20"
          - "Clean log files and temp directories"
          - "Archive old data"
      - id: rb-app-error
        title: "Application Error Runbook"
        keywords: ["error", "exception", "crash", "fatal"]
        steps:
          - "Check application logs for stack traces"
          - "Verify external dependencies (DB, API, cache)"
          - "Check recent deployments for regression"
          - "Restart the service if unresponsive"
          - "Escalate to development team if recurring"

  action.safe:
    enabled: true
    autoPropose: true
    proposalDelaySec: 5
    actions:
      - id: restart-on-error
        actionType: restart.service
        description: "Restart the affected service to recover from error state"
        triggerSeverity: ["critical"]
        triggerPattern: "error"
        command: "systemctl restart affected-service"
      - id: alert-on-warning
        actionType: notify.team
        description: "Send alert notification to the operations team"
        triggerSeverity: ["warning", "critical"]
        command: "notify-send 'OpsPilot Alert'"

  openclaw.tools:
    enabled: true

  notifier.channels:
    enabled: true
    rateLimitPerMinute: 60
    channels:
      - id: console-all
        type: console
        events:
          - incident.created
          - action.proposed
          - action.approved
          - action.executed
          - enrichment.completed
        minSeverity: info
      # Example webhook channel (disabled by default):
      # - id: slack-critical
      #   type: webhook
      #   events:
      #     - incident.created
      #     - action.executed
      #   minSeverity: critical
      #   webhookUrl: https://hooks.slack.com/services/XXX/YYY/ZZZ
      #   webhookMethod: POST
      #   webhookHeaders:
      #     Authorization: "Bearer your-token"

  detector.threshold:
    enabled: true
    maxIncidentsPerMinute: 30
    rules:
      - id: cpu-high
        metric: "(?:cpu|CPU) usage"
        valuePattern: "(\\d+)%"
        threshold: 90
        operator: gt
        windowMs: 60000
        minSamples: 1
        severity: critical
        title: "High CPU usage detected"
        description: "CPU usage at $value% exceeds $threshold% threshold"
        cooldownMs: 60000
      - id: memory-low
        metric: "(?:free|available) memory"
        valuePattern: "(\\d+)\\s*MB"
        threshold: 500
        operator: lt
        windowMs: 60000
        minSamples: 2
        severity: warning
        title: "Low memory warning"
        description: "Free memory at $value MB, below $threshold MB threshold"
        cooldownMs: 120000
      - id: disk-high
        metric: "disk usage"
        valuePattern: "(\\d+)%"
        threshold: 85
        operator: gte
        windowMs: 300000
        minSamples: 1
        severity: warning
        title: "High disk usage"
        description: "Disk usage at $value%, threshold $threshold%"
        cooldownMs: 300000

  detector.anomaly:
    enabled: false
    maxIncidentsPerMinute: 10
    metrics:
      - id: cpu-anomaly
        name: "CPU Usage Anomaly"
        pattern: "cpu_usage"
        valuePattern: "cpu_usage[=:](\\d+\\.?\\d*)"
        method: zscore
        sensitivity: 3.0
        direction: both
        trainingWindowSize: 100
        minTrainingSamples: 20
        severity: warning
        cooldownMs: 300000
      - id: memory-anomaly
        name: "Memory Usage Anomaly"
        pattern: "memory_usage"
        valuePattern: "memory_usage[=:](\\d+\\.?\\d*)"
        method: mad
        sensitivity: 3.0
        direction: high
        trainingWindowSize: 200
        minTrainingSamples: 30
        severity: warning
        cooldownMs: 300000

  ui.api:
    enabled: true
    host: "0.0.0.0"
    port: 3000
    basePath: /api
    corsOrigin: "*"

  ui.websocket:
    enabled: true
    host: "0.0.0.0"
    port: 3001
    heartbeatIntervalMs: 30000
    maxClients: 100
    subscribableEvents:
      - incident.created
      - incident.updated
      - enrichment.completed
      - action.proposed
      - action.approved
      - action.executed
      - log.ingested

  connector.metrics:
    enabled: true
    intervalMs: 10000
    enabledMetrics:
      - cpu
      - memory
      - loadAvg
    thresholds:
      cpuPercent: 90
      memoryPercent: 90
    source: system-metrics

  enricher.correlator:
    enabled: true
    timeWindowMs: 60000
    similarityThreshold: 0.4
    maxGroupSize: 50
    stormThreshold: 5
    maxGroups: 500
    groupTtlMs: 3600000

  # ── Incident Deduplication & Suppression ────────────────────────────
  # Suppresses duplicate incidents within a time window.
  enricher.dedup:
    enabled: true
    windowMs: 300000       # 5 minutes
    fingerprintFields:
      - title
      - severity
      - detectedBy
    maxFingerprints: 10000
    emitSuppressed: true

  # ── Escalation Engine ──────────────────────────────────────────────────
  # Escalates unresolved incidents through configurable policy levels.
  action.escalation:
    enabled: true
    checkIntervalMs: 30000
    maxTrackedIncidents: 5000
    resolvedStatuses:
      - resolved
      - closed
    acknowledgedPausesEscalation: true
    policies:
      - id: critical-sla
        matchSeverity:
          - critical
        levels:
          - level: 1
            afterMs: 300000       # 5 minutes
            notify: ["ops-team"]
            repeat: false
          - level: 2
            afterMs: 900000       # 15 minutes
            notify: ["ops-manager"]
            repeat: false
          - level: 3
            afterMs: 1800000      # 30 minutes
            notify: ["vp-engineering"]
            repeat: true
            repeatIntervalMs: 600000
      - id: warning-sla
        matchSeverity:
          - warning
        levels:
          - level: 1
            afterMs: 900000       # 15 minutes
            notify: ["ops-team"]
            repeat: false

  # ── Health Check Connector ───────────────────────────────────────────
  # Probes HTTP/TCP endpoints on a schedule.
  # Failures emit log.ingested events that feed into the detection pipeline.
  connector.healthCheck:
    enabled: false
    intervalMs: 30000
    timeoutMs: 10000
    source: health-check
    endpoints: []
    # Example endpoint config:
    # endpoints:
    #   - id: api-health
    #     name: "API Server"
    #     url: "http://localhost:3000/health"
    #     method: GET
    #     expectedStatus: 200
    #     severity: critical
    #     consecutiveFailures: 2
    #   - id: db-tcp
    #     name: "Database"
    #     url: "tcp://localhost:5432"
    #     severity: critical
    #     consecutiveFailures: 3

  # ── Slack Webhook Notifier ──────────────────────────────────────────────
  # Requires a Slack Incoming Webhook URL.
  # Create one at: https://api.slack.com/messaging/webhooks
  notifier.slack:
    enabled: false
    webhookUrl: ""                  # Required — paste your webhook URL
    # channel: "#ops-alerts"       # Override channel (optional)
    username: OpsPilot
    iconEmoji: ":robot_face:"
    events:
      - incident.created
      - action.proposed
      - action.executed
      - enrichment.completed
    minSeverity: warning
    rateLimitPerMinute: 30
    timeoutMs: 10000

  # ── PagerDuty Events API v2 Notifier ───────────────────────────────────
  # Requires a PagerDuty Events API v2 Integration Key (routing key).
  # Create one in PagerDuty → Service → Integrations → Events API v2.
  notifier.pagerduty:
    enabled: false
    routingKey: ""                 # Required — paste your integration key
    apiUrl: "https://events.pagerduty.com/v2/enqueue"
    events:
      - incident.created
      - action.executed
    minSeverity: critical
    dedupKeyPrefix: opspilot
    source: OpsPilot
    # component: web-server       # Optional — PagerDuty component field
    # group: production           # Optional — PagerDuty group field
    rateLimitPerMinute: 20
    timeoutMs: 10000

  # ── Runbook Automation Engine ────────────────────────────────────────
  # Executes suggested runbooks from AI summary enrichment.
  # Supports approval-gated and auto-execute modes.
  action.runbook:
    enabled: false
    autoExecute: false
    requireApprovalPerStep: true
    stepTimeoutMs: 300000
    maxConcurrentRunbooks: 10
    maxRunbookHistory: 500
    cooldownMs: 60000
    severityFilter:
      - warning
      - critical

  # ── Microsoft Teams Webhook Notifier ──────────────────────────────────
  # Requires a Microsoft Teams Incoming Webhook URL.
  # Create one via Teams channel → Connectors → Incoming Webhook.
  notifier.teams:
    enabled: false
    webhookUrl: ""                 # Required — paste your webhook URL
    events:
      - incident.created
      - action.proposed
      - action.executed
      - enrichment.completed
    minSeverity: warning
    rateLimitPerMinute: 30
    timeoutMs: 10000

  # ── Syslog Connector ─────────────────────────────────────────────────
  # Receives syslog messages over UDP or TCP, parses RFC 3164/5424.
  connector.syslog:
    enabled: false
    protocol: udp                  # udp or tcp
    host: "0.0.0.0"
    port: 1514
    source: syslog
    maxMessageSize: 8192
    parseRfc: auto                 # 3164, 5424, or auto

  # ── Journald Connector ───────────────────────────────────────────────
  # Reads systemd journal entries via journalctl subprocess.
  connector.journald:
    enabled: false
    pollIntervalMs: 2000
    source: journald
    units: []                      # Filter to specific systemd units
    priorities: []                 # Filter by syslog priority (0-6)
    maxEntriesPerPoll: 500
    sinceBoot: true

  # ── Kubernetes Connector ──────────────────────────────────────────────
  # Polls K8s API for Events, Pod status, and Node conditions.
  connector.kubernetes:
    enabled: false
    pollIntervalMs: 10000
    apiUrl: "https://kubernetes.default.svc"
    token: ""
    tokenPath: "/var/run/secrets/kubernetes.io/serviceaccount/token"
    caPath: "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
    namespace: ""                  # Empty for all namespaces
    watchEvents: true
    watchPods: true
    watchNodes: true
    timeoutMs: 10000

  # ── CloudWatch Logs Connector ─────────────────────────────────────────
  # Polls AWS CloudWatch Logs for log events across multiple log groups.
  connector.cloudwatch:
    enabled: false
    region: "us-east-1"
    accessKeyId: ""
    secretAccessKey: ""
    logGroups: []                  # Required — list of log group names
    pollIntervalMs: 30000
    source: cloudwatch
    lookbackMs: 300000
    maxEventsPerPoll: 1000
    filterPattern: ""

  # ── Email Notifier ───────────────────────────────────────────────────
  # Sends formatted email notifications via SMTP.
  notifier.email:
    enabled: false
    smtpHost: ""                   # Required — SMTP server hostname
    smtpPort: 587
    secure: false
    username: ""
    password: ""
    from: "opspilot@localhost"
    to: []                         # Required — recipient email addresses
    subjectPrefix: "[OpsPilot]"
    events:
      - incident.created
      - action.proposed
      - action.executed
      - enrichment.completed
    minSeverity: warning
    rateLimitPerMinute: 10
    timeoutMs: 30000

  # ── HTML Dashboard ───────────────────────────────────────────────────
  # Self-contained HTML dashboard for operational visibility.
  ui.dashboard:
    enabled: true
    host: "0.0.0.0"
    port: 3002
    title: "OpsPilot Dashboard"
    refreshIntervalMs: 10000
    maxRecentEvents: 100

storage:
  engine: memory
  # To enable persistent file-based storage:
  # engine: file
  # options:
  #   dataDir: ./data
  #
  # To enable SQLite persistent storage (recommended for production):
  # engine: sqlite
  # options:
  #   dbPath: ./data/opspilot.db

# ── Authentication ──────────────────────────────────────────────────────────
# When enabled, all API endpoints require a valid Bearer JWT or X-API-Key
# header (except paths listed in publicPaths).
#
# Quick start: set OPSPILOT_JWT_SECRET and/or OPSPILOT_API_KEY env vars.
auth:
  enabled: false
  # jwtSecret: "change-me-to-a-256-bit-secret"  # or set OPSPILOT_JWT_SECRET env var
  # jwtExpiresIn: "8h"
  # jwtIssuer: "opspilot"
  # publicPaths:
  #   - /api/health
  # apiKeys:
  #   - label: ci-pipeline
  #     key: sk-your-api-key-here
  #     role: operator
  #   - label: monitoring
  #     key: sk-monitoring-key
  #     role: viewer

# Optional directory for external plugin modules (dynamic loading at startup)
# pluginsDir: ./plugins

logging:
  level: info
  format: text
  output: console
